<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />

    <title>VS Code 代码片段</title>

    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />

    <link rel="stylesheet" href="./dist/reveal.css" />
    <link rel="stylesheet" href="./dist/theme/black.css" id="theme" />
    <link rel="stylesheet" href="./plugin/highlight/monokai.css" />
  </head>

  <body>
    <div class="reveal deck1">
      <div class="slides">
        <section>
          <h1>VS Code 代码片段</h1>
        </section>
        <section>
          <ul style="line-height: 2">
            <li>什么是代码片段</li>
            <li>VS Code 自带的增删改查</li>
            <li>拓展程序的增删改查</li>
            <li>代码片段高级用法</li>
            <li>优雅地修改代码片段文件</li>
          </ul>
        </section>
        <section>
          <h2>什么是代码片段</h2>
          <img src="./images/snippets-demo.webp" alt="" />
        </section>
        <section>
          <h2>VS Code 自带的增删改查</h2>
        </section>
        <section>
          <p>
            Code > Preferences > Configure User Snippets
            打开代码片段文件，通过编辑如下 JSON 文件<span class="zyb-highlight"
              >创建</span
            >、<span class="zyb-highlight">修改</span>和<span
              class="zyb-highlight"
              >删除</span
            >，工作区输入代码片段的前缀<span class="zyb-highlight">查询</span
            >并使用。
          </p>
          <pre data-id="code-animation">
            <code class="hljs" data-trim data-line-numbers>
            {
              "post": {
                "prefix": "post",
                "description": "post",
                "scope": "javascript",
                "body": [
                  "axios",
                  "  .post(\"/user\", {",
                  "    firstName: \"Fred\",",
                  "    lastName: \"Flintstone\",",
                  "  })",
                  "  .then(function (response) {",
                  "    console.log(response);",
                  "  })",
                  "  .catch(function (error) {",
                  "    console.log(error);",
                  "  });",
                  ""
                ]
              }
            }
						</code>
          </pre>
        </section>
        <section>
          <h2>
            <a
              href="https://marketplace.visualstudio.com/items?itemName=zjffun.snippetsmanager"
              >拓展程序</a
            >的增删改查
          </h2>
        </section>
        <section>
          <p>选中一段代码<span class="zyb-highlight">创建</span>代码片段</p>
          <img
            width="500px"
            src="./images/snippetsmanager-create1.webp"
            alt=""
          />
        </section>
        <section>
          <p>点击按钮<span class="zyb-highlight">删除</span>代码片段</p>
          <img src="./images/snippetsmanager-delete.webp" alt="" />
        </section>
        <section>
          <section>
            <p>
              在表单或编辑器中<span class="zyb-highlight">修改</span
              >代码片段，工作区输入代码片段的前缀<span class="zyb-highlight"
                >查询</span
              >并使用。
            </p>
            <img src="./images/snippetsmanager-edit.webp" alt="" />
          </section>
          <section>
            <p>
              在表单或编辑器中<span class="zyb-highlight">修改</span
              >代码片段，工作区输入代码片段的前缀<span class="zyb-highlight"
                >查询</span
              >并使用。
            </p>
            <img src="./images/snippetsmanager-edit-body.webp" alt="" />
          </section>
        </section>
        <section>
          <h2>代码片段高级用法</h2>
          <ul>
            <li>代码片段范围</li>
            <li>代码片段语法</li>
            <li>代码片段配合快捷键</li>
          </ul>
        </section>
        <section>
          <h3>代码片段范围</h3>
          <ul>
            <li>
              语言范围：通过 scope
              或用户代码片段的文件名可以指定代码片段在哪些语言下可用。
            </li>
            <li>
              使用范围：工作区的代码片段只能用于该工作区，用户和拓展程序提供的代码片段可以作用于文件。
            </li>
          </ul>
        </section>
        <section>
          <section>
            <h3>代码片段语法</h3>
          </section>
          <section>
            <p>制表位、占位符和选项</p>
            <pre data-id="code-animation">
              <code class="hljs language-text" data-trim data-line-numbers>
              for (${1|let,var|} i = 0; i < ${2:array}.length; i++) {
                const item = $2[i];
              }
              $0
              </code>
            </pre>
          </section>
          <section>
            <p>变量</p>
            <pre data-id="code-animation">
              <code class="hljs language-text" data-trim data-line-numbers>
              TM_SELECTED_TEXT: ${TM_SELECTED_TEXT}
              TM_CURRENT_LINE: ${TM_CURRENT_LINE}
              TM_CURRENT_WORD: ${TM_CURRENT_WORD}
              TM_LINE_INDEX: ${TM_LINE_INDEX}
              TM_LINE_NUMBER: ${TM_LINE_NUMBER}
              TM_FILENAME: ${TM_FILENAME}
              TM_FILENAME_BASE: ${TM_FILENAME_BASE}
              TM_DIRECTORY: ${TM_DIRECTORY}
              TM_FILEPATH: ${TM_FILEPATH}
              RELATIVE_FILEPATH: ${RELATIVE_FILEPATH}
              CLIPBOARD: \${CLIPBOARD}
              WORKSPACE_NAME: ${WORKSPACE_NAME}
              WORKSPACE_FOLDER: ${WORKSPACE_FOLDER}
              CURSOR_INDEX: ${CURSOR_INDEX}
              CURSOR_NUMBER: ${CURSOR_NUMBER}
              
              CURRENT_YEAR: ${CURRENT_YEAR}
              CURRENT_YEAR_SHORT: ${CURRENT_YEAR_SHORT}
              CURRENT_MONTH: ${CURRENT_MONTH}
              CURRENT_MONTH_NAME: ${CURRENT_MONTH_NAME}
              CURRENT_MONTH_NAME_SHORT: ${CURRENT_MONTH_NAME_SHORT}
              CURRENT_DATE: ${CURRENT_DATE}
              CURRENT_DAY_NAME: ${CURRENT_DAY_NAME}
              CURRENT_DAY_NAME_SHORT: ${CURRENT_DAY_NAME_SHORT}
              CURRENT_HOUR: ${CURRENT_HOUR}
              CURRENT_MINUTE: ${CURRENT_MINUTE}
              CURRENT_SECOND: ${CURRENT_SECOND}
              CURRENT_SECONDS_UNIX: ${CURRENT_SECONDS_UNIX}
              
              RANDOM: ${RANDOM}
              RANDOM_HEX: ${RANDOM_HEX}
              UUID: ${UUID}
              
              BLOCK_COMMENT_START: ${BLOCK_COMMENT_START}
              BLOCK_COMMENT_END: ${BLOCK_COMMENT_END}
              LINE_COMMENT: ${LINE_COMMENT}
              </code>
            </pre>
          </section>
          <section>
            <h3>实战</h3>
          </section>
          <section>
            <p>打印剪贴板</p>
            <pre data-id="code-animation">
              <code class="hljs language-text" data-trim data-line-numbers>
              console.log('${CLIPBOARD}: ', ${CLIPBOARD});
              </code>
            </pre>
          </section>
          <section>
            <p>剪贴板 require 转 import</p>
            <pre data-id="code-animation">
              <code class="hljs language-text" data-trim data-line-numbers>
              ${CLIPBOARD/.*? +(.*?) += +require\((.*?)\)/import $1 from $2/g}
  
              const path = require('path');
              </code>
            </pre>
          </section>
        </section>
        <section>
          <section>
            <h3>代码片段配合快捷键</h3>
          </section>
          <section>
            <p>如何方便地打印 getInfo</p>
            <pre data-id="code-animation">
              <code class="hljs language-js" data-trim data-line-numbers>
              async function getInfo(arg) {
                await new Promise((res) => setTimeout(res, 500));
                return `getInfo ${arg}`;
              }
              
              async function main() {
                return getInfo(`test`);
              }
              
              main();
              </code>
            </pre>
          </section>
          <section>
            <p>创建代码片段</p>
            <pre data-id="code-animation">
              <code class="hljs language-text" data-trim data-line-numbers>
              /* TODO: revert */ (() => {
                const TM_SELECTED_TEXT_DATA = ${TM_SELECTED_TEXT};
                if (TM_SELECTED_TEXT_DATA.then) {
                  TM_SELECTED_TEXT_DATA.then((data) => {
                    console.log(`${TM_SELECTED_TEXT/`/\`/g}:Promise:${TM_FILENAME}:${TM_LINE_NUMBER}: `, data);
                  });
                  return TM_SELECTED_TEXT_DATA;
                }
                console.log(`${TM_SELECTED_TEXT/`/\`/g}:${TM_FILENAME}:${TM_LINE_NUMBER}: `, TM_SELECTED_TEXT_DATA);
                return TM_SELECTED_TEXT_DATA;
              })(); /* TM_SELECTED_TEXT: getInfo(`test`) */
              </code>
            </pre>
          </section>
          <section>
            <p>绑定快捷键</p>
            <pre data-id="code-animation">
              <code class="hljs language-json" data-trim data-line-numbers>
              {
                "key": "cmd+l cmd+g",
                "command": "editor.action.insertSnippet",
                "when": "editorTextFocus",
                "args": {
                  "name": "clg-selected"
                }
              },
              </code>
            </pre>
          </section>
        </section>
        <section>
          <h2>优雅地修改代码片段文件</h2>
        </section>
        <section>
          <section>
            <h3>问题</h3>
          </section>
          <section>
            <p>JS Object 的特性 & JSON.stringify 缩进丢失</p>
            <pre data-id="code-animation">
            <code class="hljs language-js" data-trim data-line-numbers>
            let json = `{
              "1": {
                "prefix": "1"
              },
              "0": {
                "prefix": "0"
              }
            }`;

            const snippets = JSON.parse(json);
            json = JSON.stringify(snippets);

            console.log(json);
            // {"0":{"prefix":"0"},"1":{"prefix":"1"}}
						</code>
          </pre>
          </section>
          <section>
            <p>带注释的 JSON</p>
            <pre data-id="code-animation">
            <code class="hljs language-json" data-trim data-line-numbers>
            {
              // 文档相关
              "doc": {
                "prefix": "doc",
                "description": "doc",
                "scope": "markdown",
                "body": [
                  "### 1、产品文档",
                  "",
                  "### 2、相关人员",
                  "",
                  "### 3、代码仓库、线上地址",
                  "",
                  "### 4、部署方式",
                  "",
                  "### 5、注意事项",
                  "",
                  "### 6、TODO"
                ]
              }
            }
            </code>
          </pre>
          </section>
        </section>
        <section>
          <section>
            <h3>解决</h3>
          </section>
          <section>
            <p>
              使用
              <a href="https://www.npmjs.com/package/jsonc-parser">
                jsonc-parser
              </a>
            </p>
            <ul>
              <li>将 JSON 的对象转为 JS 的 Map</li>
              <li>修改指定的 JSON 元素</li>
            </ul>
          </section>
          <section>
            <p>
              <a
                href="https://github.com/zjffun/vscode-snippets-manager/blob/main/src/CodeSnippetsService.ts#L53-L89"
              >
                将 JSON 的对象转为 JS 的 Map
              </a>
            </p>
            <pre data-id="code-animation">
            <code class="hljs language-js" data-trim data-line-numbers>
            const visitor = {
              onObjectBegin() {
                // 创建 map 并入栈
              },
              onObjectProperty() {
                // 保存属性名
              },
              onObjectEnd() {
                // 出栈
              },
              onArrayBegin() {
                // 创建 array 并入栈
              },
              onArrayEnd() {
                // 出栈
              },
              onLiteralValue() {
                // 根据属性名为栈顶元素设置属性
              },
            };
            
            visit(this.textDocument.getText(), visitor);
          </code>
        </pre>
          </section>
          <section>
            <p>
              修改指定的 JSON 元素
              <a
                href="https://github.com/zjffun/vscode-snippets-manager/blob/main/src/vscode/src/vs/base/common/jsonEdit.ts#L14-L120"
              >
                vs/base/common/jsonEdit.ts
              </a>
            </p>

            <div style="margin: 0 -100px -70px">
              <pre data-id="code-animation">
              <code class="hljs language-js" data-trim data-line-numbers>
              let json = `{
                "1": {
                    // 这里的缩进不一样
                    "prefix": "1"
                },
                "0": {
                  "prefix": "0"
                }
              }`;
  
              const [edit] = setProperty(json, ["0", "body"], "test body", {});
              json = applyEdit(json, edit);
  
              console.log(json);
              /*
              {
                "1": {
                    // 这里的缩进不一样
                    "prefix": "1"
                },
                "0": {
                  "prefix": "0",
                  "body": "test body"
                }
              }
              */
              </code>
            </pre>
            </div>
          </section>
        </section>

        <section>
          <h1>感谢聆听</h1>
        </section>
      </div>
    </div>

    <style>
      html,
      body {
        margin: 0;
        padding: 0;
      }
      .reveal {
        width: 100%;
        height: 100vh;
        --r-heading-text-transform: none;
      }
      .zyb-highlight {
        color: rgba(237, 100, 166, 1);
      }
    </style>

    <script src="./dist/reveal.js"></script>
    <script src="./plugin/highlight/highlight.js"></script>
    <script src="./plugin/markdown/markdown.js"></script>
    <script src="./plugin/math/math.js"></script>
    <script>
      let deck1 = new Reveal(document.querySelector(".deck1"), {
        hash: true,
        embedded: true,
        progress: false,
        keyboardCondition: "focused",
        plugins: [RevealHighlight],
      });
      deck1.initialize();
    </script>
  </body>
</html>
